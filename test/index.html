<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–ø–∏—Å—å –≥–æ–ª–æ—Å–∞</title>
</head>
<body>
  <h2>üéô –ó–∞–ø–∏—à–∏ —Å–≤–æ–π –≥–æ–ª–æ—Å</h2>
  <button id="recordBtn">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
  <button id="stopBtn" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
  <p id="status"></p>
  <p id="code"></p>
  <a href="play.html">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—é ‚Üí</a>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");
    const codeEl = document.getElementById("code");

    recordBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.start();
      status.textContent = "‚è∫ –ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...";
      recordBtn.disabled = true;
      stopBtn.disabled = false;

      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    };

    stopBtn.onclick = () => {
      mediaRecorder.stop();
      status.textContent = "‚úÖ –ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞";
      recordBtn.disabled = false;
      stopBtn.disabled = true;

      mediaRecorder.onstop = async () => {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        const base64 = await blobToBase64(blob);

        const code = Math.floor(1000000 + Math.random() * 9000000).toString();
        codeEl.textContent = "–¢–≤–æ–π –∫–æ–¥: " + code;

        let db = JSON.parse(localStorage.getItem("voiceDB") || "{}");
        db[code] = base64;
        localStorage.setItem("voiceDB", JSON.stringify(db));
      };
    };

    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>