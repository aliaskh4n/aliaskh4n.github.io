<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';script-src 'self' 'unsafe-inline' https://telegram.org;style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;font-src https://fonts.gstatic.com;img-src 'self' data: https:;connect-src 'self' https://nekros.vercel.app;">
    <title>Mines üíé</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: Inter, -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--tg-theme-bg-color, #fff);
            color: var(--tg-theme-text-color, #000);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent
        }

        .container {
            max-width: 100%;
            padding: 12px
        }

        .header {
            padding: 8px 0 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px
        }

        .header-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #9333ea, #c084fc);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(147, 51, 234, .3)
        }

        .header-info {
            display: flex;
            flex-direction: column
        }

        .header-title {
            font-size: 18px;
            font-weight: 700
        }

        .header-subtitle {
            color: var(--tg-theme-hint-color, #999);
            font-size: 12px
        }

        .balance-mini {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-radius: 10px;
            padding: 8px 14px;
            display: flex;
            flex-direction: column;
            align-items: flex-end
        }

        .balance-mini-label {
            color: var(--tg-theme-hint-color, #999);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 2px
        }

        .balance-mini-value {
            font-size: 16px;
            font-weight: 700
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px
        }

        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-radius: 12px;
            padding: 12px;
            text-align: center
        }

        .stat-label {
            color: var(--tg-theme-hint-color, #999);
            font-size: 11px;
            margin-bottom: 4px;
            text-transform: uppercase
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -.5px
        }

        .stat-value.highlight {
            background: linear-gradient(135deg, #9333ea, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text
        }

        .settings-panel {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            transition: opacity .3s
        }

        .setting-row {
            margin-bottom: 14px
        }

        .setting-row:last-child {
            margin-bottom: 0
        }

        .setting-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block
        }

        .setting-buttons {
            display: flex;
            gap: 8px
        }

        .setting-btn {
            flex: 1;
            background: var(--tg-theme-bg-color, #fff);
            border: 2px solid transparent;
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s
        }

        .setting-btn:active {
            transform: scale(.95)
        }

        .setting-btn.active {
            background: linear-gradient(135deg, #9333ea, #c084fc);
            color: #fff;
            box-shadow: 0 4px 12px rgba(147, 51, 234, .3)
        }

        .game-board {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px
        }

        .mines-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px
        }

        .mine-cell {
            aspect-ratio: 1;
            background: var(--tg-theme-bg-color, #fff);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            transition: all .2s;
            border: 2px solid transparent;
            box-shadow: 0 2px 6px rgba(0, 0, 0, .08)
        }

        .mine-cell:active {
            transform: scale(.92)
        }

        .mine-cell.revealed {
            pointer-events: none
        }

        .mine-cell.revealed.safe {
            background: linear-gradient(135deg, #34c759, #30d158);
            color: #fff;
            animation: revealSafe .4s cubic-bezier(.68, -.55, .265, 1.55);
            box-shadow: 0 4px 12px rgba(52, 199, 89, .4)
        }

        .mine-cell.revealed.bomb {
            background: linear-gradient(135deg, #ff3b30, #ff453a);
            color: #fff;
            animation: explode .5s ease;
            box-shadow: 0 4px 12px rgba(255, 59, 48, .4)
        }

        .mine-cell.disabled {
            opacity: .5;
            pointer-events: none
        }

        @keyframes revealSafe {
            0% {
                transform: scale(.7)rotate(-10deg);
                opacity: 0
            }

            50% {
                transform: scale(1.15)rotate(5deg)
            }

            100% {
                transform: scale(1)rotate(0);
                opacity: 1
            }
        }

        @keyframes explode {

            0%,
            100% {
                transform: scale(1)
            }

            25% {
                transform: scale(1.25)rotate(5deg)
            }

            75% {
                transform: scale(1.25)rotate(-5deg)
            }
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        .control-btn {
            background: var(--tg-theme-button-color, #3390ec);
            color: #fff;
            border: none;
            padding: 16px;
            font-size: 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all .2s;
            box-shadow: 0 4px 12px rgba(51, 144, 236, .3)
        }

        .control-btn:active {
            transform: scale(.96)
        }

        .control-btn:disabled {
            background: var(--tg-theme-hint-color, #999);
            opacity: .4;
            cursor: not-allowed;
            box-shadow: none
        }

        .control-btn.cashout {
            background: linear-gradient(135deg, #34c759, #30d158);
            box-shadow: 0 4px 12px rgba(52, 199, 89, .3)
        }

        .message {
            background: var(--tg-theme-secondary-bg-color, #f4f4f5);
            border-radius: 12px;
            padding: 14px 16px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center
        }

        .message.win {
            background: linear-gradient(135deg, rgba(52, 199, 89, .15), rgba(48, 209, 88, .15));
            color: #34c759
        }

        .message.lose {
            background: linear-gradient(135deg, rgba(255, 59, 48, .15), rgba(255, 69, 58, .15));
            color: #ff3b30
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="header-icon">üíé</div>
                <div class="header-info">
                    <div class="header-title">Mines</div>
                    <div class="header-subtitle">–ù–∞–π–¥–∏ –∞–ª–º–∞–∑—ã</div>
                </div>
            </div>
            <div class="balance-mini">
                <div class="balance-mini-label">–ë–∞–ª–∞–Ω—Å</div>
                <div class="balance-mini-value" id="balance">-</div>
            </div>
        </div>
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-label">–°—Ç–∞–≤–∫–∞</div>
                <div class="stat-value" id="currentBet">50</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–ú–Ω–æ–∂–∏—Ç–µ–ª—å</div>
                <div class="stat-value highlight" id="multiplier">1.0x</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">–í—ã–∏–≥—Ä—ã—à</div>
                <div class="stat-value" id="potentialWin">0</div>
            </div>
        </div>
        <div class="settings-panel" id="settingsPanel">
            <div class="setting-row">
                <label class="setting-label">–°—Ç–∞–≤–∫–∞</label>
                <div class="setting-buttons">
                    <button class="setting-btn active" onclick="changeBet(50)">50</button>
                    <button class="setting-btn" onclick="changeBet(100)">100</button>
                    <button class="setting-btn" onclick="changeBet(200)">200</button>
                    <button class="setting-btn" onclick="changeBet(500)">500</button>
                    <button class="setting-btn" onclick="changeBet(1000)">1000</button>
                </div>
            </div>
            <div class="setting-row">
                <label class="setting-label">–ë–æ–º–±</label>
                <div class="setting-buttons">
                    <button class="setting-btn" onclick="changeMines(3)">3</button>
                    <button class="setting-btn active" onclick="changeMines(5)">5</button>
                    <button class="setting-btn" onclick="changeMines(7)">7</button>
                </div>
            </div>
        </div>
        <div class="game-board">
            <div class="mines-grid" id="minesGrid"></div>
            <div class="controls">
                <button class="control-btn" id="startBtn" onclick="startGame()">–ù–∞—á–∞—Ç—å</button>
                <button class="control-btn cashout" id="cashoutBtn" onclick="cashout()" disabled>–ó–∞–±—Ä–∞—Ç—å üí∞</button>
            </div>
        </div>
        <div class="message" id="message">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –Ω–∞—á–Ω–∏—Ç–µ –∏–≥—Ä—É</div>
    </div>
    <script>
        const g = {
            api: 'https://nekros.vercel.app/api',
            tg: window.Telegram.WebApp,
            user: { id: sessionStorage.getItem('user_id'), token: sessionStorage.getItem('token'), balance: parseInt(sessionStorage.getItem('user_balance') || '0') },
            bet: 50,
            mines: 5,
            active: false,
            id: null,
            revealed: 0,
            mults: { 3: [1.2, 1.5, 1.9, 2.4, 3.0, 3.8, 4.8, 6.0, 7.5, 9.4, 11.8, 14.8, 18.5, 23.1, 28.9, 36.1, 45.2, 56.5, 70.6, 88.3, 110.4, 138.0], 5: [1.3, 1.7, 2.2, 2.9, 3.8, 5.0, 6.5, 8.5, 11.1, 14.5, 18.9, 24.6, 32.0, 41.6, 54.1, 70.4, 91.5, 119.0, 154.7, 201.1], 7: [1.4, 1.9, 2.6, 3.5, 4.8, 6.5, 8.8, 12.0, 16.3, 22.1, 30.0, 40.8, 55.4, 75.3, 102.3, 139.0, 188.9, 256.7] }
        };
        const ui = {
            balance: document.getElementById('balance'),
            bet: document.getElementById('currentBet'),
            mult: document.getElementById('multiplier'),
            win: document.getElementById('potentialWin'),
            grid: document.getElementById('minesGrid'),
            start: document.getElementById('startBtn'),
            cashout: document.getElementById('cashoutBtn'),
            msg: document.getElementById('message'),
            settings: document.getElementById('settingsPanel')
        };
        function init() {
            g.tg.ready();
            g.tg.expand();
            g.tg.BackButton.show();
            g.tg.BackButton.onClick(() => window.history.back());
            if (!g.user.id || !g.user.token) {
                showMsg('–í–µ—Ä–Ω–∏—Ç–µ—Å—å –Ω–∞ –≥–ª–∞–≤–Ω—É—é', 'lose');
                ui.start.disabled = true;
                return;
            }
            ui.balance.textContent = g.user.balance.toLocaleString();
            createGrid();
        }
        function createGrid() {
            ui.grid.innerHTML = '';
            for (let i = 0; i < 25; i++) {
                const c = document.createElement('div');
                c.className = 'mine-cell';
                c.textContent = '‚ùì';
                c.onclick = () => revealCell(i);
                ui.grid.appendChild(c);
            }
        }
        function changeBet(a) {
            if (g.active) return;
            g.bet = a;
            ui.bet.textContent = a;
            document.querySelectorAll('.setting-row:first-child .setting-btn').forEach(b => b.classList.toggle('active', parseInt(b.textContent) === a));
            updateWin();
        }
        function changeMines(c) {
            if (g.active) return;
            g.mines = c;
            document.querySelectorAll('.setting-row:last-child .setting-btn').forEach(b => b.classList.toggle('active', parseInt(b.textContent) === c));
            updateWin();
        }
        function updateWin() {
            const m = g.mults[g.mines];
            if (!m) return;
            const idx = Math.max(0, g.revealed);
            if (idx >= m.length) return;
            const mult = m[idx] || 1;
            ui.mult.textContent = mult.toFixed(1) + 'x';
            ui.win.textContent = Math.floor(g.bet * mult).toLocaleString();
        }
        async function api(e, m, b) {
            try {
                const o = { method: m, headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${g.user.token}` } };
                if (b) o.body = JSON.stringify(b);
                const r = await fetch(`${g.api}${e}`, o);
                if (!r.ok) {
                    const d = await r.json().catch(() => ({ error: 'Network error' }));
                    throw new Error(d.error || `HTTP ${r.status}`);
                }
                return await r.json();
            } catch (err) {
                throw err;
            }
        }
        async function startGame() {
            if (g.bet > g.user.balance) {
                showMsg('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 'lose');
                g.tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            try {
                ui.start.disabled = true;
                showMsg('–ù–∞—á–∏–Ω–∞–µ–º...');
                const res = await api('/game/mines/start', 'POST', { userId: g.user.id, bet: g.bet, minesCount: g.mines });
                g.active = true;
                g.id = res.gameId;
                g.revealed = 0;
                g.user.balance = res.newBalance;
                ui.balance.textContent = g.user.balance.toLocaleString();
                sessionStorage.setItem('user_balance', g.user.balance);
                ui.start.textContent = '–ù–æ–≤–∞—è –∏–≥—Ä–∞';
                ui.cashout.disabled = false;
                ui.settings.style.opacity = '0.5';
                ui.settings.style.pointerEvents = 'none';
                createGrid();
                updateWin();
                showMsg('–í—ã–±–∏—Ä–∞–π—Ç–µ —è—á–µ–π–∫–∏! üçÄ');
                g.tg.HapticFeedback.impactOccurred('medium');
            } catch (e) {
                showMsg(`–û—à–∏–±–∫–∞: ${e.message}`, 'lose');
                ui.start.disabled = false;
                g.tg.HapticFeedback.notificationOccurred('error');
            }
        }
        async function revealCell(idx) {
            if (!g.active) return;
            const cells = ui.grid.children;
            const cell = cells[idx];
            if (cell.classList.contains('revealed')) return;
            try {
                cell.classList.add('disabled');
                g.tg.HapticFeedback.impactOccurred('light');
                const res = await api('/game/mines/reveal', 'POST', { userId: g.user.id, gameId: g.id, position: idx });
                if (res.hit === 'bomb') {
                    cell.classList.add('revealed', 'bomb');
                    cell.textContent = 'üí£';
                    endGame(false, res);
                    g.tg.HapticFeedback.notificationOccurred('error');
                } else {
                    cell.classList.add('revealed', 'safe');
                    cell.textContent = 'üíé';
                    g.revealed = res.revealedCount || (g.revealed + 1);
                    updateWin();
                    showMsg(`–ê–ª–º–∞–∑ –Ω–∞–π–¥–µ–Ω! üíé ${g.revealed}`, 'win');
                    g.tg.HapticFeedback.notificationOccurred('success');
                }
            } catch (e) {
                cell.classList.remove('disabled');
                showMsg(`–û—à–∏–±–∫–∞: ${e.message}`, 'lose');
                g.tg.HapticFeedback.notificationOccurred('error');
            }
        }
        async function cashout() {
            if (!g.active || g.revealed === 0) {
                showMsg('–û—Ç–∫—Ä–æ–π—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —è—á–µ–π–∫—É', 'lose');
                g.tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            try {
                ui.cashout.disabled = true;
                showMsg('–ó–∞–±–∏—Ä–∞–µ–º...');
                const res = await api('/game/mines/cashout', 'POST', { userId: g.user.id, gameId: g.id });
                endGame(true, res);
                g.tg.HapticFeedback.notificationOccurred('success');
            } catch (e) {
                showMsg(`–û—à–∏–±–∫–∞: ${e.message}`, 'lose');
                ui.cashout.disabled = false;
                g.tg.HapticFeedback.notificationOccurred('error');
            }
        }
        function endGame(won, res) {
            g.active = false;
            g.id = null;
            g.revealed = 0;
            g.user.balance = res.newBalance;
            ui.balance.textContent = g.user.balance.toLocaleString();
            sessionStorage.setItem('user_balance', g.user.balance);
            ui.start.disabled = false;
            ui.start.textContent = '–ù–∞—á–∞—Ç—å';
            ui.cashout.disabled = true;
            ui.settings.style.opacity = '1';
            ui.settings.style.pointerEvents = 'auto';
            Array.from(ui.grid.children).forEach(c => c.classList.add('disabled'));
            if (won) {
                showMsg(`üéâ –í—ã–∏–≥—Ä—ã—à: +${res.winAmount} üí∞`, 'win');
            } else {
                showMsg(`üí£ –ë–æ–º–±–∞! –ü–æ—Ç–µ—Ä—è–Ω–æ: ${g.bet}`, 'lose');
            }
            g.revealed = 0;
            updateWin();
        }
        function showMsg(t, type = '') {
            ui.msg.textContent = t;
            ui.msg.className = 'message ' + type;
        }
        init();
    </script>
</body>

</html>
