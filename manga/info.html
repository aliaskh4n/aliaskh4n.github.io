<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Чтение главы</title>
  <style>
    :root {
      --tg-theme-bg-color: var(--tg-theme-bg-color, #ffffff);
      --tg-theme-text-color: var(--tg-theme-text-color, #000000);
      --tg-theme-hint-color: var(--tg-theme-hint-color, #999999);
      --tg-theme-link-color: var(--tg-theme-link-color, #2481cc);
      --tg-theme-button-color: var(--tg-theme-button-color, #2481cc);
      --tg-theme-button-text-color: var(--tg-theme-button-text-color, #ffffff);
      --tg-theme-secondary-bg-color: var(--tg-theme-secondary-bg-color, #f1f1f1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      overflow-x: hidden;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      line-height: 1.4;
    }

    .chapter-container {
      width: 100%;
      min-height: 100vh;
      position: relative;
    }

    .chapter-header {
      position: sticky;
      top: 0;
      background-color: var(--tg-theme-bg-color);
      border-bottom: 1px solid var(--tg-theme-secondary-bg-color);
      padding: 12px 16px;
      z-index: 100;
      backdrop-filter: blur(8px);
    }

    .chapter-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--tg-theme-text-color);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chapter-subtitle {
      font-size: 14px;
      color: var(--tg-theme-hint-color);
      text-align: center;
      margin-top: 4px;
    }

    .chapter-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-bottom: 60px;
    }

    .chapter-page {
      width: 100%;
      max-width: 100vw;
      height: auto;
      object-fit: contain;
      background-color: var(--tg-theme-secondary-bg-color);
      display: block;
      margin: 0;
      border: none;
    }

    .page-separator {
      height: 2px;
      background: linear-gradient(
        to right, 
        transparent, 
        var(--tg-theme-hint-color), 
        transparent
      );
      opacity: 0.3;
      margin: 8px 0;
    }

    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 60vh;
      gap: 20px;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--tg-theme-secondary-bg-color);
      border-top: 2px solid var(--tg-theme-button-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: var(--tg-theme-hint-color);
      font-size: 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-container {
      background-color: var(--tg-theme-secondary-bg-color);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 16px;
      text-align: center;
      border-left: 4px solid #ff3b30;
    }

    .error-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--tg-theme-text-color);
      margin-bottom: 8px;
    }

    .error-message {
      color: var(--tg-theme-hint-color);
      font-size: 14px;
      line-height: 1.4;
    }

    .chapter-navigation {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--tg-theme-bg-color);
      border-top: 1px solid var(--tg-theme-secondary-bg-color);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(8px);
    }

    .nav-button {
      background-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
      min-width: 80px;
    }

    .nav-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .nav-button:active:not(:disabled) {
      opacity: 0.8;
    }

    .chapter-counter {
      color: var(--tg-theme-hint-color);
      font-size: 14px;
      font-weight: 500;
    }

    .image-placeholder {
      width: 100%;
      min-height: 200px;
      background-color: var(--tg-theme-secondary-bg-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--tg-theme-hint-color);
      font-size: 14px;
      text-align: center;
      border: 2px dashed var(--tg-theme-hint-color);
      opacity: 0.6;
      margin: 4px 0;
    }

    .pages-counter {
      position: fixed;
      top: 70px;
      right: 16px;
      background-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      z-index: 99;
    }

    /* Оптимизация для Telegram тем */
    @media (prefers-color-scheme: dark) {
      :root {
        --tg-theme-bg-color: #212121;
        --tg-theme-text-color: #ffffff;
        --tg-theme-hint-color: #a8a8a8;
        --tg-theme-secondary-bg-color: #181818;
        --tg-theme-button-color: #2481cc;
      }
    }

    /* Убираем возможность выделения и перетаскивания */
    img {
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      pointer-events: none;
    }

    /* Скрываем контекстное меню на изображениях */
    .chapter-page {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="chapter-container">
    <!-- Заголовок главы -->
    <div class="chapter-header" id="chapterHeader" style="display: none;">
      <div class="chapter-title" id="chapterTitle">Загрузка...</div>
      <div class="chapter-subtitle" id="chapterSubtitle"></div>
    </div>

    <!-- Счетчик страниц -->
    <div class="pages-counter" id="pagesCounter" style="display: none;">
      0/0
    </div>

    <!-- Загрузка -->
    <div id="loadingContainer" class="loading-container">
      <div class="loading-spinner"></div>
      <div class="loading-text">Загрузка главы...</div>
    </div>

    <!-- Ошибка -->
    <div id="errorContainer" class="error-container" style="display: none;">
      <div class="error-title">Ошибка загрузки</div>
      <div class="error-message" id="errorMessage"></div>
    </div>

    <!-- Содержимое главы -->
    <div id="chapterContent" class="chapter-content" style="display: none;"></div>

    <!-- Навигация -->
    <div class="chapter-navigation" id="chapterNavigation" style="display: none;">
      <button class="nav-button" id="prevButton" disabled>Назад</button>
      <div class="chapter-counter" id="chapterCounter">Глава 1</div>
      <button class="nav-button" id="nextButton" disabled>Далее</button>
    </div>
  </div>

  <!-- Telegram Mini App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script>
    const API_CONFIG = {
      baseUrl: 'https://nekros.tatokz2006.workers.dev',
      timeout: 12000,
      retryAttempts: 2,
      retryDelay: 1000
    };

    let currentMangaId = null;
    let currentChapterId = null;
    let totalPages = 0;
    let loadedPages = 0;

    // Инициализация Telegram Mini App
    function initTelegramApp() {
      if (window.Telegram?.WebApp) {
        const tgApp = window.Telegram.WebApp;
        tgApp.ready();
        tgApp.expand();
        
        // Применяем тему Telegram
        if (tgApp.themeParams) {
          const root = document.documentElement;
          Object.entries(tgApp.themeParams).forEach(([key, value]) => {
            root.style.setProperty(`--tg-theme-${key.replace(/_/g, '-')}`, value);
          });
        }

        // Настройка Back Button
        tgApp.BackButton.show();
        tgApp.BackButton.onClick(() => {
          tgApp.close();
        });

        // Отключаем вертикальные свайпы
        tgApp.disableVerticalSwipes();
        
        console.log('Telegram Mini App initialized');
      }
    }

    // Получение параметров из URL
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        mangaId: urlParams.get('manga'),
        chapterId: urlParams.get('chapter')
      };
    }

    // Показ ошибки
    function showError(message, details = '') {
      hideLoading();
      const errorContainer = document.getElementById('errorContainer');
      const errorMessage = document.getElementById('errorMessage');
      
      errorMessage.textContent = details || message;
      errorContainer.style.display = 'block';
      
      console.error('Error:', message, details);
    }

    // Скрытие загрузки
    function hideLoading() {
      document.getElementById('loadingContainer').style.display = 'none';
    }

    // Обновление счетчика страниц
    function updatePagesCounter() {
      const counter = document.getElementById('pagesCounter');
      if (totalPages > 0) {
        counter.textContent = `${loadedPages}/${totalPages}`;
        counter.style.display = 'block';
      }
    }

    // Создание элемента изображения с обработкой загрузки
    function createImageElement(imageSrc, container, pageIndex) {
      const img = document.createElement('img');
      img.className = 'chapter-page';
      img.alt = `Страница ${pageIndex + 1}`;
      img.loading = 'lazy';
      
      // Placeholder пока изображение не загружено
      const placeholder = document.createElement('div');
      placeholder.className = 'image-placeholder';
      placeholder.textContent = `Загрузка страницы ${pageIndex + 1}...`;
      container.appendChild(placeholder);

      img.onload = () => {
        container.replaceChild(img, placeholder);
        loadedPages++;
        updatePagesCounter();
        console.log(`Page ${pageIndex + 1} loaded successfully`);
      };

      img.onerror = () => {
        placeholder.textContent = `Ошибка загрузки страницы ${pageIndex + 1}`;
        placeholder.style.borderColor = '#ff3b30';
        console.error(`Failed to load page ${pageIndex + 1}: ${imageSrc}`);
      };

      // Устанавливаем src после настройки обработчиков
      img.src = imageSrc;
    }

    // Отображение содержимого главы
    function displayChapterContent(chapterData) {
      const contentContainer = document.getElementById('chapterContent');
      const headerTitle = document.getElementById('chapterTitle');
      const headerSubtitle = document.getElementById('chapterSubtitle');
      const chapterCounter = document.getElementById('chapterCounter');
      
      contentContainer.innerHTML = '';

      // Обновляем заголовок
      const mangaName = chapterData.mangaName || 'Манга';
      const chapterTitle = chapterData.chapterInfo?.title || `Глава ${currentChapterId}`;
      
      headerTitle.textContent = chapterTitle;
      headerSubtitle.textContent = mangaName;
      chapterCounter.textContent = `Глава ${currentChapterId}`;

      // Получаем страницы
      const pages = chapterData.chapterContent?.pages || [];
      
      if (!pages.length) {
        showError('Страницы главы не найдены', 'Содержимое главы временно недоступно');
        return;
      }

      totalPages = pages.length;
      loadedPages = 0;
      updatePagesCounter();

      // Создаем изображения для каждой страницы
      pages.forEach((pageUrl, index) => {
        if (pageUrl && pageUrl.trim()) {
          createImageElement(pageUrl.trim(), contentContainer, index);
          
          // Добавляем разделитель между страницами (кроме последней)
          if (index < pages.length - 1) {
            const separator = document.createElement('div');
            separator.className = 'page-separator';
            contentContainer.appendChild(separator);
          }
        }
      });

      // Показываем интерфейс
      hideLoading();
      document.getElementById('chapterHeader').style.display = 'block';
      document.getElementById('chapterContent').style.display = 'flex';
      document.getElementById('chapterNavigation').style.display = 'flex';
      
      // Настраиваем навигацию
      setupNavigation();
      
      console.log(`Chapter displayed: ${pages.length} pages`);
    }

    // Настройка навигации между главами
    function setupNavigation() {
      const prevButton = document.getElementById('prevButton');
      const nextButton = document.getElementById('nextButton');
      
      // Проверяем доступность предыдущей/следующей главы
      const prevChapterId = parseInt(currentChapterId) - 1;
      const nextChapterId = parseInt(currentChapterId) + 1;
      
      prevButton.disabled = prevChapterId < 1;
      // nextButton остается активной (пользователь может попробовать)
      
      prevButton.onclick = () => {
        if (prevChapterId >= 1) {
          window.location.href = `chapter.html?manga=${currentMangaId}&chapter=${prevChapterId}`;
        }
      };
      
      nextButton.onclick = () => {
        window.location.href = `chapter.html?manga=${currentMangaId}&chapter=${nextChapterId}`;
      };
    }

    // Функция с повторными попытками для запросов
    async function fetchWithRetry(url, options = {}, attempts = API_CONFIG.retryAttempts) {
      for (let i = 0; i < attempts; i++) {
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

          const response = await fetch(url, {
            ...options,
            signal: controller.signal,
            headers: {
              'Accept': 'application/json',
              'Cache-Control': 'no-cache',
              ...options.headers
            }
          });

          clearTimeout(timeoutId);
          return response;

        } catch (error) {
          console.log(`Attempt ${i + 1} failed:`, error.message);
          
          if (i === attempts - 1) {
            throw error;
          }
          
          // Ждем перед повторной попыткой
          await new Promise(resolve => setTimeout(resolve, API_CONFIG.retryDelay * (i + 1)));
        }
      }
    }

    // Загрузка данных главы
    async function fetchChapterData(mangaId, chapterId) {
      const url = `${API_CONFIG.baseUrl}/?id=${mangaId}&cr=${chapterId}`;
      console.log(`Fetching chapter data: ${url}`);

      const response = await fetchWithRetry(url);
      
      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`HTTP ${response.status}: ${errorText}`);
      }

      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        throw new Error('Сервер вернул некорректные данные');
      }

      return await response.json();
    }

    // Основная функция загрузки главы
    async function loadChapter() {
      const params = getUrlParams();
      
      if (!params.mangaId || !params.chapterId) {
        showError('Неверные параметры', 'Параметры главы не указаны в URL');
        return;
      }

      currentMangaId = params.mangaId;
      currentChapterId = params.chapterId;

      console.log(`Loading chapter: Manga ${currentMangaId}, Chapter ${currentChapterId}`);

      try {
        const chapterData = await fetchChapterData(currentMangaId, currentChapterId);
        
        if (!chapterData) {
          throw new Error('Данные главы не получены');
        }

        displayChapterContent(chapterData);

      } catch (error) {
        console.error('Chapter loading error:', error);
        
        let errorMessage = 'Ошибка загрузки главы';
        let errorDetails = error.message;

        if (error.name === 'AbortError') {
          errorMessage = 'Превышено время ожидания';
          errorDetails = 'Сервер не отвечает. Проверьте подключение к интернету.';
        } else if (error.message.includes('HTTP 404')) {
          errorMessage = 'Глава не найдена';
          errorDetails = `Глава ${currentChapterId} не существует для этой манги.`;
        } else if (error.message.includes('HTTP 403')) {
          errorMessage = 'Доступ запрещен';
          errorDetails = 'Нет прав доступа к содержимому главы.';
        } else if (error.message.includes('fetch')) {
          errorMessage = 'Проблема с подключением';
          errorDetails = 'Не удается связаться с сервером.';
        }

        showError(errorMessage, errorDetails);
      }
    }

    // Предварительная загрузка следующей главы (опционально)
    function preloadNextChapter() {
      if (currentMangaId && currentChapterId) {
        const nextChapterId = parseInt(currentChapterId) + 1;
        const preloadUrl = `${API_CONFIG.baseUrl}/?id=${currentMangaId}&cr=${nextChapterId}`;
        
        // Создаем скрытый fetch для предзагрузки
        fetch(preloadUrl, { 
          method: 'HEAD',
          cache: 'force-cache' 
        }).catch(() => {
          // Игнорируем ошибки предзагрузки
        });
      }
    }

    // Обработка видимости страницы для оптимизации
    function handleVisibilityChange() {
      if (document.hidden) {
        // Приостанавливаем загрузку изображений если страница скрыта
        console.log('Page hidden, pausing image loading');
      } else {
        // Возобновляем загрузку
        console.log('Page visible, resuming operations');
      }
    }

    // Инициализация приложения
    function initApp() {
      initTelegramApp();
      loadChapter();
      
      // Предзагрузка следующей главы через 3 секунды после загрузки текущей
      setTimeout(preloadNextChapter, 3000);
      
      // Слушаем изменения видимости страницы
      document.addEventListener('visibilitychange', handleVisibilityChange);
      
      // Отключаем контекстное меню на изображениях
      document.addEventListener('contextmenu', (e) => {
        if (e.target.tagName === 'IMG') {
          e.preventDefault();
        }
      });
      
      // Предотвращаем случайные жесты
      document.addEventListener('touchstart', (e) => {
        if (e.touches.length > 1) {
          e.preventDefault();
        }
      });
      
      console.log('Telegram Chapter Reader initialized');
    }

    // Запуск приложения
    document.addEventListener('DOMContentLoaded', initApp);

    // Обработка ошибок на уровне окна
    window.addEventListener('error', (e) => {
      console.error('Global error:', e.error);
      if (e.error && e.error.name === 'ChunkLoadError') {
        // Перезагружаем страницу при ошибках загрузки чанков
        window.location.reload();
      }
    });

    // Service Worker для кеширования (если поддерживается)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch((error) => {
        console.log('Service Worker registration failed:', error);
      });
    }
  </script>
</body>
</html>
