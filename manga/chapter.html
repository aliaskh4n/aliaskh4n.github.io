<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Чтение главы - Manga App</title>
  <style>
    body {
      margin: 0;
      font-family: "Roboto-Black", Helvetica, sans-serif;
      background-color: #0d1117;
      color: #fff;
      padding: 0;
      user-select: none;
    }

    /* Контейнер для контента */
    .chapter-container {
      margin: 0;
      padding: 0;
    }

    /* Контент главы */
    .chapter-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0;
    }

    .chapter-page {
      width: 100%;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      background: #000;
      border-radius: 0;
      margin: 0;
      padding: 0;
      display: block;
    }

    /* Индикаторы состояния */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 50vh;
      gap: 20px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid rgba(255, 59, 48, 0.3);
      border-radius: 12px;
      padding: 20px;
      color: #ff3b30;
      text-align: center;
      margin: 20px;
    }
  </style>
</head>
<body>
  <!-- Контейнер -->
  <div class="chapter-container">
    <!-- Загрузка -->
    <div id="loadingDiv" class="loading">
      <div class="loading-spinner"></div>
      <div>Загрузка главы...</div>
    </div>

    <!-- Ошибка -->
    <div id="errorDiv" class="error" style="display: none;"></div>

    <!-- Контент главы -->
    <div id="chapterContent" class="chapter-content" style="display: none;"></div>
  </div>

  <script>
    const API_CONFIG = {
      baseUrl: 'https://nekros.tatokz2006.workers.dev',
      timeout: 15000
    };

    // Получение параметров из URL
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        mangaId: urlParams.get('manga'),
        chapterId: urlParams.get('chapter')
      };
    }

    // Показ ошибки
    function showError(message) {
      document.getElementById('loadingDiv').style.display = 'none';
      document.getElementById('chapterContent').style.display = 'none';
      
      const errorDiv = document.getElementById('errorDiv');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    }

    // Создание элемента изображения
    function createImageElement(imageSrc, container) {
      const img = document.createElement('img');
      img.className = 'chapter-page';
      img.alt = 'Страница';
      img.src = imageSrc;
      container.appendChild(img);
    }

    // Отображение контента главы
    function displayChapterContent(chapterData) {
      console.log('Отображаем контент главы:', chapterData);
      
      const contentContainer = document.getElementById('chapterContent');
      contentContainer.innerHTML = '';

      const pages = (chapterData.chapterContent && chapterData.chapterContent.pages) || [];

      if (!pages.length) {
        showError('Страницы главы не найдены');
        return;
      }

      pages.forEach((pageUrl) => {
        if (pageUrl && pageUrl.trim()) {
          createImageElement(pageUrl.trim(), contentContainer);
        }
      });

      document.getElementById('loadingDiv').style.display = 'none';
      document.getElementById('chapterContent').style.display = 'flex';
    }

    // Получение данных главы с API
    async function fetchChapterData(mangaId, chapterId) {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

        const url = `${API_CONFIG.baseUrl}/?id=${mangaId}&cr=${chapterId}`;
        const response = await fetch(url, { signal: controller.signal });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`Ошибка HTTP: ${response.status}`);

        return await response.json();
      } catch (error) {
        console.error('Ошибка получения данных главы:', error);
        throw error;
      }
    }

    // Основная функция загрузки
    async function loadChapter() {
      const params = getUrlParams();
      if (!params.mangaId || !params.chapterId) {
        showError('Параметры главы не указаны в URL.');
        return;
      }

      try {
        const chapterData = await fetchChapterData(params.mangaId, params.chapterId);
        displayChapterContent(chapterData);
      } catch (error) {
        showError('Ошибка загрузки главы: ' + error.message);
      }
    }

    document.addEventListener('DOMContentLoaded', loadChapter);
  </script>
</body>
</html>
