<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manga App</title>
  <style>
    body {
      margin: 0;
      font-family: "Roboto-Black", Helvetica, sans-serif;
      background-color: #17212b;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px 0 90px;
    }

    .app-container {
      width: 420px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .search-bar {
      width: 100%;
      height: 45px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(12px);
      border-radius: 15px;
      position: relative;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.15);
      transition: transform 0.2s, background 0.2s;
      will-change: transform;
    }
    .search-bar:hover { transform: scale(1.02); background: rgba(255,255,255,0.08); }
    .search-bar img { width: 18px; height: 18px; transition: all 0.2s; }
    .search-bar input {
      position: absolute; left:10px; right:10px; height:28px;
      border:none; border-radius:10px; padding:0 10px;
      background-color: rgba(0,0,0,0.3); color:#fff;
      font-size:14px; opacity:0; pointer-events:none; transition: all 0.3s;
    }
    .search-bar.active img { opacity:0; pointer-events:none; }
    .search-bar.active input { opacity:1; pointer-events:auto; }

    .cards-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(185px, 1fr));
      gap: 15px;
    }

    .card {
      display: flex; flex-direction: column;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(15px);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: transform 0.3s, box-shadow 0.3s, background 0.3s;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 8px 25px rgba(0,0,0,0.5);
      will-change: transform;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.6);
      background: rgba(255,255,255,0.08);
    }
    .card img {
      width:100%; height:200px;
      object-fit:cover; border-radius:16px 16px 0 0;
      background: rgba(255,255,255,0.1);
    }
    .card-title {
      position: relative;
      padding:10px 8px; text-align:center;
      font-weight:900; font-size:14px; color:#fff;
      min-height:45px; display:flex; align-items:center; justify-content:center;
      text-shadow:0 1px 3px rgba(0,0,0,0.6);
    }
    .card-title::before {
      content:"";
      position:absolute; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.3); border-radius:0;
      z-index:-1;
    }
    .card-stats {
      display:flex; justify-content:center; align-items:center;
      gap:6px; padding:6px 0; font-size:13px; color:#ffcc00;
      background: rgba(0,0,0,0.2); border-top:1px solid rgba(255,255,255,0.1);
    }
    .card-stats img { width:16px; height:16px; }

    .bottom-menu {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 420px;
      height: calc(70px + env(safe-area-inset-bottom));
      background: rgba(40,45,55,0.4);
      backdrop-filter: blur(12px);
      display: flex;
      justify-content: space-around;
      align-items: flex-end;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.5);
      z-index: 100;
      padding: 0 10px 25px 0px;
      border-radius: 15px 15px 0 0;
    }
    .bottom-menu button {
      background: rgba(255,255,255,0.1); backdrop-filter: blur(8px);
      border:none; border-radius:15px; cursor:pointer;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      color:#fff; font-size:10px; width:60px; height:50px;
      transition: transform 0.2s, background 0.2s;
    }
    .bottom-menu button img { width:24px; height:24px; margin-bottom:2px; }
    .bottom-menu button:hover { transform:scale(1.1); background: rgba(255,255,255,0.15); }

    /* Плейсхолдер для изображений */
    .placeholder-img {
      width: 100%;
      height: 200px;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255,255,255,0.5);
      font-size: 12px;
      text-align: center;
      border: 2px dashed rgba(255,255,255,0.2);
    }

    /* Индикатор загрузки */
    .loading {
      text-align: center;
      color: #fff;
      font-size: 16px;
      padding: 50px 0;
    }

    .error {
      background: rgba(255, 59, 48, 0.1);
      border: 1px solid rgba(255, 59, 48, 0.3);
      border-radius: 12px;
      padding: 20px;
      color: #ff3b30;
      text-align: center;
      margin: 20px 0;
    }

    @media(max-width:420px){
      .app-container { width:100%; padding:0 10px; }
      .cards-container { grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); }
      .bottom-menu { width: calc(100% - 20px); }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="search-bar" id="searchBar">
      <img src="https://em-content.zobj.net/source/apple/419/magnifying-glass-tilted-left_1f50d.png" alt="Search">
      <input type="text" id="searchInput" placeholder="Поиск...">
    </div>
    
    <div id="loadingDiv" class="loading">Загрузка...</div>
    <div id="errorDiv" class="error" style="display: none;"></div>
    
    <div class="cards-container" id="cardsContainer"></div>
  </div>

  <div class="bottom-menu">
    <button><img src="https://em-content.zobj.net/source/apple/419/three-oclock_1f552.png"></button>
    <button><img src="https://em-content.zobj.net/source/apple/419/bookmark_1f516.png"></button>
    <button><img src="https://em-content.zobj.net/source/apple/419/bell_1f514.png"></button>
    <button><img src="https://em-content.zobj.net/source/apple/419/money-with-wings_1f4b8.png"></button>
  </div>

  <script>
    // Конфигурация API
    const API_CONFIG = {
      baseUrl: 'https://nekros.tatokz2006.workers.dev',
      timeout: 10000 // 10 секунд таймаут
    };

    let allManga = []; // Для поиска

    // Функция для создания плейсхолдера изображения
    function createImagePlaceholder(title = 'Обложка недоступна') {
      const placeholder = document.createElement('div');
      placeholder.className = 'placeholder-img';
      placeholder.textContent = title;
      return placeholder;
    }

    // Функция для показа ошибки
    function showError(message) {
      document.getElementById('loadingDiv').style.display = 'none';
      const errorDiv = document.getElementById('errorDiv');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      document.getElementById('cardsContainer').style.display = 'none';
    }

    // Функция для скрытия индикаторов загрузки/ошибок
    function hideLoading() {
      document.getElementById('loadingDiv').style.display = 'none';
      document.getElementById('errorDiv').style.display = 'none';
      document.getElementById('cardsContainer').style.display = 'grid';
    }

    // Функция загрузки манги
    async function loadManga() {
      try {
        console.log('Начинаем загрузку манги...');
        
        // Создаем контроллер для таймаута
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.timeout);

        const response = await fetch(API_CONFIG.baseUrl, {
          signal: controller.signal,
          headers: {
            'Accept': 'application/json',
            'Origin': window.location.origin
          }
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`Ошибка HTTP: ${response.status} ${response.statusText}`);
        }

        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error('Сервер вернул не JSON данные');
        }

        allManga = await response.json();
        console.log(`Загружено ${allManga.length} манги`);

        displayManga(allManga);
        hideLoading();

      } catch (error) {
        console.error('Ошибка загрузки манги:', error);
        let errorMessage = 'Ошибка загрузки данных. ';
        
        if (error.name === 'AbortError') {
          errorMessage += 'Превышено время ожидания.';
        } else if (error.message.includes('fetch')) {
          errorMessage += 'Проблемы с подключением к серверу.';
        } else {
          errorMessage += error.message;
        }
        
        showError(errorMessage + ' Попробуйте обновить страницу.');
      }
    }

    // Функция для отображения манги
    function displayManga(mangaArray) {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = "";
      
      if (!mangaArray || mangaArray.length === 0) {
        container.innerHTML = '<div style="color: #999; text-align: center; padding: 50px; grid-column: 1/-1;">Манга не найдена</div>';
        return;
      }

      const fragment = document.createDocumentFragment();

      mangaArray.forEach(manga => {
        const cardDiv = document.createElement('div');
        cardDiv.className = 'card';
        cardDiv.setAttribute('data-manga-id', manga.id);
        
        // Создаем HTML структуру карточки
        const cardHTML = `
          <div class="card-image-container"></div>
          <div class="card-title">${manga.name || 'Без названия'}</div>
          <div class="card-stats">
            <img src="https://em-content.zobj.net/source/apple/419/heart-on-fire_2764-fe0f-200d-1f525.png" alt="Like">
            <span>${manga.likes || '0'}</span>
          </div>
        `;
        
        cardDiv.innerHTML = cardHTML;
        
        // Обрабатываем изображение
        const imageContainer = cardDiv.querySelector('.card-image-container');
        
        if (manga.img && manga.img.trim()) {
          const img = document.createElement('img');
          img.src = manga.img.trim();
          img.alt = manga.name || 'Обложка манги';
          img.loading = 'lazy';
          
          img.onload = () => {
            imageContainer.appendChild(img);
          };
          
          img.onerror = () => {
            console.log(`Ошибка загрузки изображения для ${manga.name}`);
            const placeholder = createImagePlaceholder('Обложка\nнедоступна');
            imageContainer.appendChild(placeholder);
          };
          
          // Таймаут для медленных изображений
          setTimeout(() => {
            if (!imageContainer.hasChildNodes()) {
              const placeholder = createImagePlaceholder('Загрузка...');
              imageContainer.appendChild(placeholder);
            }
          }, 3000);
        } else {
          // Если нет URL изображения, сразу показываем плейсхолдер
          const placeholder = createImagePlaceholder('Нет\nобложки');
          imageContainer.appendChild(placeholder);
        }

        // ВАЖНО: Добавляем обработчик клика на карточку
        cardDiv.addEventListener('click', (e) => {
          e.preventDefault();
          const mangaId = manga.id;
          console.log(`Переход к манге ID: ${mangaId}`);
          // Переходим на страницу с детальной информацией
          window.location.href = `info.html?id=${mangaId}`;
        });

        fragment.appendChild(cardDiv);
      });

      container.appendChild(fragment);
    }

    // Функция поиска
    function searchManga(query) {
      if (!query.trim()) {
        displayManga(allManga);
        return;
      }

      const filtered = allManga.filter(manga => 
        (manga.name && manga.name.toLowerCase().includes(query.toLowerCase())) ||
        (manga.author && manga.author.toLowerCase().includes(query.toLowerCase()))
      );

      displayManga(filtered);
    }

    // Инициализация поиска
    function initializeSearch() {
      const searchBar = document.getElementById('searchBar');
      const searchInput = document.getElementById('searchInput');

      searchBar.addEventListener('click', () => { 
        if (!searchBar.classList.contains('active')) {
          searchBar.classList.add('active'); 
          searchInput.focus(); 
        }
      });

      searchInput.addEventListener('input', (e) => {
        searchManga(e.target.value);
      });

      searchInput.addEventListener('blur', () => {
        if (!searchInput.value.trim()) {
          searchBar.classList.remove('active');
        }
      });

      // Обработка Enter
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchManga(e.target.value);
        }
      });
    }

    // Инициализация приложения
    document.addEventListener('DOMContentLoaded', () => {
      initializeSearch();
      loadManga();
    });
  </script>
</body>
</html>
