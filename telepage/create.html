<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–æ–∑–¥–∞—Ç—å —Å—Ç–∞—Ç—å—é</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #fff);
            --tg-text: var(--tg-theme-text-color, #23262f);
            --tg-hint: var(--tg-theme-hint-color, #8b8b8b);
            --tg-link: var(--tg-theme-link-color, #0088cc);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
            color: var(--tg-text);
        }
        
        body {
            background: var(--tg-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            width: 100%;
        }
        
        #animation-container {
            width: 100%;
            height: 45vh;
            max-height: 320px;
            min-height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: pan-x;
        }
        
        .editable {
            width: 100%;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            border: none;
            background: transparent;
            outline: none;
        }
        
        .quote {
            font-weight: 500;
            font-style: italic;
            color: var(--tg-link);
            text-align: center;
        }
        
        .meta, .stats {
            font-size: 14px;
            color: var(--tg-hint);
            text-align: center;
            margin: 10px 0;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: var(--tg-link);
            color: #fff;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="animation-container"></div>
    <div class="container">
        <input type="text" id="title" class="editable" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏">
        <div class="meta">–ê–≤—Ç–æ—Ä: <span id="author"></span> ¬∑ <span id="date"></span></div>
        <input type="text" id="quote" class="quote editable" placeholder="–¶–∏—Ç–∞—Ç–∞">
        <div class="stats">üëÅÔ∏è 0 –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ ¬∑ ‚ù§Ô∏è 0 –ª–∞–π–∫–æ–≤</div>
        <button id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    
    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // API URL - –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ URL –≤–∞—à–µ–≥–æ API
        const API_BASE_URL = 'http://127.0.0.1:5000';
        // URL –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—å–∏ (–Ω–∞ GitHub Pages)
        const VIEW_URL_BASE = 'https://aliaskh4n.github.io/telepage/index.html';
        // URL –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π –Ω–∞ GitHub Pages
        const GITHUB_PAGES_URL = 'https://aliaskh4n.github.io/telepage';
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ Telegram WebApp
        const telegramUser = tg.initDataUnsafe.user;
        const userId = telegramUser ? telegramUser.id : null;
        const username = telegramUser ? (telegramUser.username || `user_${userId}`) : "anonymous";
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById("author").textContent = telegramUser ? 
            (telegramUser.first_name || username) : "–ì–æ—Å—Ç—å";
        
        document.getElementById("date").textContent = new Date().toLocaleDateString("ru-RU", 
            { day: "numeric", month: "long", year: "numeric" });

        let selectedAnimation = 0;
        let animations = [];
        let animationInstance = null;

        async function loadAnimations() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–Ω–∏–º–∞—Ü–∏–π —Å API
                const response = await fetch(`${API_BASE_URL}/animations`);
                animations = await response.json();
                updateAnimation();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–π:", error);
            }
        }
        
        function updateAnimation() {
            if (animations.length === 0) return;
            
            const container = document.getElementById("animation-container");
            container.innerHTML = "";
            
            // –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å GitHub Pages
            animationInstance = lottie.loadAnimation({
                container: container,
                renderer: "svg",
                loop: true,
                autoplay: true,
                path: `${GITHUB_PAGES_URL}/animations/${animations[selectedAnimation]}`
            });
        }

        let startX = 0;
        document.getElementById("animation-container").addEventListener("touchstart", (e) => {
            startX = e.touches[0].clientX;
        });
        
        document.getElementById("animation-container").addEventListener("touchend", (e) => {
            let endX = e.changedTouches[0].clientX;
            let diff = startX - endX;
            if (Math.abs(diff) > 50 && animations.length > 0) {
                selectedAnimation = (selectedAnimation + (diff > 0 ? 1 : -1) + animations.length) % animations.length;
                updateAnimation();
            }
        });
        
        document.getElementById("save").addEventListener("click", async () => {
            if (!userId) {
                alert("–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ Telegram");
                return;
            }
            
            const title = document.getElementById("title").value.trim();
            if (!title) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏");
                return;
            }
            
            const quote = document.getElementById("quote").value.trim();
            if (!quote) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ü–∏—Ç–∞—Ç—É");
                return;
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Å—Ç–∞—Ç—å–∏
            const article = {
                title: title,
                author: document.getElementById("author").textContent,
                date: document.getElementById("date").textContent,
                quote: quote,
                views: "0",
                likes: "0",
                animation: selectedAnimation
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/create`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ 
                        username: username,
                        user_id: userId,
                        article: article 
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç—å–∏ –Ω–∞ GitHub Pages
                    const viewUrl = `${VIEW_URL_BASE}?username=${username}&id=${result.article_id}`;
                    
                    // –î–ª—è Telegram WebApp - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    if (tg.initDataUnsafe.user) {
                        tg.sendData(JSON.stringify({
                            success: true,
                            article_id: result.article_id,
                            url: viewUrl
                        }));
                    } else {
                        // –î–ª—è –±—Ä–∞—É–∑–µ—Ä–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        alert(`–°—Ç–∞—Ç—å—è —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!\nURL: ${viewUrl}`);
                        if (confirm("–•–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç—å–µ?")) {
                            window.location.href = viewUrl;
                        }
                    }
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${result.message}`);
                }
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", error);
                alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—å–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
            }
        });
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞" –≤ Telegram WebApp
        if (tg.initDataUnsafe.user) {
            tg.BackButton.onClick(() => {
                tg.close();
            });
            tg.BackButton.show();
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞–Ω–∏–º–∞—Ü–∏–π
        loadAnimations();
    </script>
</body>
</html>
