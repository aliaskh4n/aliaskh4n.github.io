<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Темная страница с JSON данными</title>
    <style>
        body {
            background-color: #0f1119;
            background-image: linear-gradient(45deg, #1a1d2e, #0f1119);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            color: #e0e0e0;
        }
        
        .glass-container {
            width: 450px;
            min-height: 300px;
            background: rgba(30, 34, 51, 0.4);
            border-radius: 15px;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 25px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .json-display {
            width: 100%;
            text-align: left;
            line-height: 1.6;
            font-size: 16px;
            margin: 0;
            white-space: pre-wrap;
            color: #bdc7d8;
        }
        
        .json-key {
            color: #73c990;
            font-weight: 500;
        }
        
        .json-string {
            color: #ff98a4;
        }
        
        .json-bracket {
            color: #c39ac9;
            font-weight: 500;
        }
        
        .json-colon {
            color: #79b8ff;
            margin-right: 8px;
        }
        
        .json-comma {
            color: #79b8ff;
        }
        
        .time-container {
            display: inline-block;
            position: relative;
            padding: 2px 4px;
            background: rgba(121, 184, 255, 0.1);
            border-radius: 4px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                background: rgba(121, 184, 255, 0.1);
            }
            50% {
                background: rgba(121, 184, 255, 0.2);
            }
            100% {
                background: rgba(121, 184, 255, 0.1);
            }
        }
        
        /* Фоновые элементы */
        .background-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        
        .shape {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(45deg, #5151cf, #2d348e);
            opacity: 0.15;
            transition: all 5s ease-in-out;
        }
        
        .shape:nth-child(1) {
            width: 300px;
            height: 300px;
            top: 20%;
            left: 25%;
            animation: float 15s ease-in-out infinite;
        }
        
        .shape:nth-child(2) {
            width: 250px;
            height: 250px;
            bottom: 15%;
            right: 30%;
            animation: float 20s ease-in-out infinite reverse;
        }
        
        .shape:nth-child(3) {
            width: 180px;
            height: 180px;
            bottom: 35%;
            left: 15%;
            animation: float 17s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(-10px, 15px) rotate(5deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }
    </style>
</head>
<body>
    <div class="background-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>
    
    <div class="glass-container">
        <pre id="json-content" class="json-display"></pre>
    </div>

    <script>
        // Кэшированные данные
        const cachedData = {
            date: "",
            time: "",
            weather: "Данные загружаются...",
            city: "Определение города..."
        };

        // Функция для получения текущей даты и времени
        function getCurrentDateTime() {
            const now = new Date();
            return {
                date: now.toLocaleDateString('ru-RU'),
                time: now.toLocaleTimeString('ru-RU')
            };
        }

        // Функция для получения геолокации (выполняется только один раз при загрузке)
        function getGeolocation() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            resolve({ lat, lon });
                        },
                        error => {
                            console.error("Ошибка геолокации:", error);
                            resolve({ lat: null, lon: null });
                        },
                        { timeout: 10000, maximumAge: 3600000 } // Кэшируем результат на час
                    );
                } else {
                    console.error("Геолокация не поддерживается браузером");
                    resolve({ lat: null, lon: null });
                }
            });
        }

        // Функция для получения города по координатам
        async function getCityByCoords(lat, lon) {
            if (!lat || !lon) return "Неизвестно";
            
            try {
                // Используем localStorage для кэширования результата
                const cacheKey = `aliaskhan_city_${lat.toFixed(3)}_${lon.toFixed(3)}`;
                const cacheTimeKey = `${cacheKey}_time`;
                
                // Проверяем, есть ли в localStorage данные о городе
                const cachedCity = localStorage.getItem(cacheKey);
                const cachedTime = localStorage.getItem(cacheTimeKey);
                
                // Если данные есть и они не старше часа, используем их
                if (cachedCity && cachedTime) {
                    const cacheAge = Date.now() - parseInt(cachedTime);
                    if (cacheAge < 3600000) { // Меньше часа
                        console.log("Загружен город из localStorage:", cachedCity);
                        return cachedCity;
                    }
                }
                
                // Если данных нет или они устарели, делаем запрос
                console.log("Запрашиваем новые данные о городе...");
                
                // Используем OpenStreetMap Nominatim API для обратного геокодирования
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&accept-language=ru`);
                const data = await response.json();
                
                const city = data.address?.city || 
                             data.address?.town || 
                             data.address?.village || 
                             data.address?.county || 
                             "Неизвестно";
                
                // Сохраняем в localStorage с временной меткой
                localStorage.setItem(cacheKey, city);
                localStorage.setItem(cacheTimeKey, Date.now().toString());
                
                console.log("Новый город сохранен в localStorage:", city);
                return city;
            } catch (error) {
                console.error("Ошибка получения города:", error);
                
                // В случае ошибки пробуем использовать последние сохраненные данные
                const cacheKey = `aliaskhan_city_${lat.toFixed(3)}_${lon.toFixed(3)}`;
                const cachedCity = localStorage.getItem(cacheKey);
                
                return cachedCity || "Неизвестно";
            }
        }

        // Функция для получения погоды
        async function getWeather(lat, lon) {
            if (!lat || !lon) return "Нет данных";
            
            try {
                // Проверяем, есть ли кэшированные данные о погоде в localStorage
                const cacheKey = `aliaskhan_weather_${lat.toFixed(3)}_${lon.toFixed(3)}`;
                const cacheTimeKey = `${cacheKey}_time`;
                
                const cachedWeather = localStorage.getItem(cacheKey);
                const cachedTime = localStorage.getItem(cacheTimeKey);
                
                // Если есть кэш и он не старше часа, используем его
                if (cachedWeather && cachedTime) {
                    const cacheAge = Date.now() - parseInt(cachedTime);
                    if (cacheAge < 3600000) { // Меньше часа
                        console.log("Загружена погода из localStorage:", cachedWeather);
                        return cachedWeather;
                    }
                }
                
                console.log("Запрашиваем новые данные о погоде...");
                
                // Здесь был бы реальный запрос к API погоды
                // Для демонстрации используем заглушку с случайной температурой
                const temp = Math.floor(Math.random() * 15) + 10; // Случайная температура от 10 до 25
                const conditions = ["ясно", "переменная облачность", "облачно", "небольшой дождь", "солнечно"];
                const randomCondition = conditions[Math.floor(Math.random() * conditions.length)];
                
                const weather = `${temp} °C, ${randomCondition}`;
                
                // Сохраняем результат в localStorage
                localStorage.setItem(cacheKey, weather);
                localStorage.setItem(cacheTimeKey, Date.now().toString());
                
                console.log("Новая погода сохранена в localStorage:", weather);
                return weather;
            } catch (error) {
                console.error("Ошибка получения погоды:", error);
                
                // В случае ошибки используем последние сохраненные данные
                const cacheKey = `aliaskhan_weather_${lat.toFixed(3)}_${lon.toFixed(3)}`;
                const cachedWeather = localStorage.getItem(cacheKey);
                
                return cachedWeather || "Данные недоступны";
            }
        }

        // Форматирование JSON с подсветкой синтаксиса
        function formatJSON(json) {
            return JSON.stringify(json, null, 4)
                .replace(/"([^"]+)":/g, '<span class="json-key">"$1"</span><span class="json-colon">:</span>')
                .replace(/: "([^"]+)"/g, ': <span class="json-string">"$1"</span>')
                .replace(/,/g, '<span class="json-comma">,</span>')
                .replace(/\{/g, '<span class="json-bracket">{</span>')
                .replace(/\}/g, '<span class="json-bracket">}</span>')
                // Особая обработка для времени - добавляем анимацию
                .replace(/"time": <span class="json-string">"([^"]+)"<\/span>/g, 
                    '"time": <span class="json-string time-container">"$1"</span>');
        }

        // Функция для обновления JSON на странице
        function updateJSON() {
            // Получаем дату и время
            const dateTime = getCurrentDateTime();
            
            // Обновляем кэш времени (всегда)
            cachedData.time = dateTime.time;
            
            // Формируем JSON с кэшированными данными
            const jsonData = {
                "Aliaskhan": {
                    "data": cachedData.date,
                    "time": cachedData.time,
                    "weather": cachedData.weather,
                    "city": cachedData.city
                }
            };
            
            // Форматируем JSON и выводим
            const jsonElement = document.getElementById('json-content');
            jsonElement.innerHTML = formatJSON(jsonData);
        }

        // Функция для сохранения последнего обновления
        function saveLastUpdate() {
            localStorage.setItem('aliaskhan_last_update', Date.now().toString());
        }
        
        // Функция для проверки, нужно ли обновлять данные
        function shouldUpdateData() {
            const lastUpdate = localStorage.getItem('aliaskhan_last_update');
            if (!lastUpdate) return true;
            
            const updateAge = Date.now() - parseInt(lastUpdate);
            return updateAge >= 3600000; // Прошел час или больше
        }
        
        // Инициализация и загрузка данных
        async function initialize() {
            // Получаем начальные данные даты и времени
            const dateTime = getCurrentDateTime();
            cachedData.date = dateTime.date;
            cachedData.time = dateTime.time;
            
            // Загружаем координаты из localStorage, если они там есть
            let coords;
            const savedLat = localStorage.getItem('aliaskhan_lat');
            const savedLon = localStorage.getItem('aliaskhan_lon');
            
            if (savedLat && savedLon) {
                coords = { lat: parseFloat(savedLat), lon: parseFloat(savedLon) };
                console.log("Загружены координаты из localStorage:", coords);
            } else {
                // Если нет, получаем новые
                coords = await getGeolocation();
                // И сохраняем их
                if (coords.lat && coords.lon) {
                    localStorage.setItem('aliaskhan_lat', coords.lat.toString());
                    localStorage.setItem('aliaskhan_lon', coords.lon.toString());
                    console.log("Сохранены новые координаты в localStorage:", coords);
                }
            }
            
            // Получаем город и погоду
            if (coords.lat && coords.lon) {
                cachedData.city = await getCityByCoords(coords.lat, coords.lon);
                cachedData.weather = await getWeather(coords.lat, coords.lon);
                saveLastUpdate();
            } else {
                cachedData.city = "Не удалось определить";
                cachedData.weather = "Нет данных";
            }
            
            // Обновляем отображение
            updateJSON();
            
            // Запускаем обновление времени каждую секунду
            setInterval(updateJSON, 1000);
            
            // Запускаем обновление даты каждый час
            setInterval(() => {
                cachedData.date = getCurrentDateTime().date;
            }, 3600000); // 1 час
            
            // Устанавливаем интервал проверки необходимости обновления города и погоды каждый час
            setInterval(async () => {
                if (shouldUpdateData() && coords.lat && coords.lon) {
                    console.log("Прошел час - обновляем данные");
                    cachedData.city = await getCityByCoords(coords.lat, coords.lon);
                    cachedData.weather = await getWeather(coords.lat, coords.lon);
                    saveLastUpdate();
                    updateJSON();
                }
            }, 60000); // Проверяем каждую минуту (для демонстрации, в реальности можно реже)
        }

        // Запускаем инициализацию при загрузке страницы
        initialize();
    </script>
</body>
</html>