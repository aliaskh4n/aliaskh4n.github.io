<?php
/**
 * Минималистичный API для управления заказами
 * 
 * Поддерживаемые запросы:
 * - GET api.php?action=get_orders - получить все заказы
 * - GET api.php?action=add_order&name=Название&payment=Статус оплаты&link=Ссылка - добавить заказ
 * - GET api.php?action=add_task&order_id=1&name=Задача&status=planned - добавить задачу
 * - GET api.php?action=update_task&order_id=1&task_id=1&status=completed - обновить статус задачи
 * - GET api.php?action=update_order&order_id=1&status=completed - обновить статус заказа
 * - GET api.php?action=update_payment&order_id=1&payment=Оплачено - обновить статус оплаты
 */

// Устанавливаем заголовки для CORS
header('Access-Control-Allow-Origin: *');
header('Content-Type: application/json; charset=UTF-8');

// Путь к файлу данных
$data_file = 'data.json';

// Получаем действие из GET-параметра
$action = isset($_GET['action']) ? $_GET['action'] : null;

// Проверяем наличие и доступность файла данных
function check_data_file($file) {
    if (!file_exists($file)) {
        // Создаем пустой файл с начальной структурой
        file_put_contents($file, json_encode([]));
    }
    
    if (!is_readable($file) || !is_writable($file)) {
        http_response_code(500);
        echo json_encode([
            'success' => false,
            'message' => 'Файл данных недоступен для чтения/записи'
        ]);
        exit;
    }
}

// Функция для чтения данных из файла
function read_data($file) {
    check_data_file($file);
    $json_data = file_get_contents($file);
    return json_decode($json_data, true) ?: [];
}

// Функция для записи данных в файл
function write_data($file, $data) {
    $json_data = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
    return file_put_contents($file, $json_data);
}

// Функция для обновления статуса заказа на основе задач
function update_order_status(&$order) {
    if (empty($order['tasks'])) {
        return;
    }
    
    $all_completed = true;
    $any_in_progress = false;
    
    foreach ($order['tasks'] as $task) {
        if ($task['status'] !== 'completed') {
            $all_completed = false;
        }
        if ($task['status'] === 'in-progress') {
            $any_in_progress = true;
        }
    }
    
    if ($all_completed) {
        $order['status'] = 'completed';
    } elseif ($any_in_progress) {
        $order['status'] = 'in-progress';
    } else {
        $order['status'] = 'planned';
    }
}

// Обработка различных действий
switch ($action) {
    case 'get_orders':
        // Получаем все заказы
        $data = read_data($data_file);
        echo json_encode($data);
        break;
        
    case 'add_order':
        // Проверяем наличие обязательного параметра
        if (!isset($_GET['name']) || empty($_GET['name'])) {
            http_response_code(400);
            echo json_encode([
                'success' => false,
                'message' => 'Не указано название заказа'
            ]);
            exit;
        }
        
        $data = read_data($data_file);
        
        // Находим максимальный ID
        $max_id = 0;
        foreach ($data as $order) {
            if ($order['id'] > $max_id) {
                $max_id = $order['id'];
            }
        }
        
        // Создаем новый заказ
        $new_order = [
            'id' => $max_id + 1,
            'name' => $_GET['name'],
            'status' => 'planned',
            'payment' => isset($_GET['payment']) ? $_GET['payment'] : 'Не оплачено',
            'link' => isset($_GET['link']) ? $_GET['link'] : '#',
            'tasks' => []
        ];
        
        $data[] = $new_order;
        
        if (write_data($data_file, $data)) {
            echo json_encode([
                'success' => true,
                'message' => 'Заказ успешно добавлен',
                'order_id' => $new_order['id']
            ]);
        } else {
            http_response_code(500);
            echo json_encode([
                'success' => false,
                'message' => 'Ошибка при сохранении данных'
            ]);
        }
        break;
        
    case 'add_task':
        // Проверяем наличие обязательных параметров
        if (!isset($_GET['order_id']) || !isset($_GET['name']) || empty($_GET['name'])) {
            http_response_code(400);
            echo json_encode([
                'success' => false,
                'message' => 'Не указан ID заказа или название задачи'
            ]);
            exit;
        }
        
        $order_id = (int)$_GET['order_id'];
        $data = read_data($data_file);
        
        // Ищем нужный заказ
        $order_index = -1;
        foreach ($data as $index => $order) {
            if ($order['id'] === $order_id) {
                $order_index = $index;
                break;
            }
        }
        
        if ($order_index === -1) {
            http_response_code(404);
            echo json_encode([
                'success' => false,
                'message' => 'Заказ с указанным ID не найден'
            ]);
            exit;
        }
        
        // Находим максимальный ID задачи
        $max_task_id = 0;
        foreach ($data[$order_index]['tasks'] as $task) {
            if ($task['id'] > $max_task_id) {
                $max_task_id = $task['id'];
            }
        }
        
        // Создаем новую задачу
        $new_task = [
            'id' => $max_task_id + 1,
            'name' => $_GET['name'],
            'status' => isset($_GET['status']) ? $_GET['status'] : 'planned'
        ];
        
        $data[$order_index]['tasks'][] = $new_task;
        
        // Обновляем статус заказа
        update_order_status($data[$order_index]);
        
        if (write_data($data_file, $data)) {
            echo json_encode([
                'success' => true,
                'message' => 'Задача успешно добавлена',
                'task_id' => $new_task['id']
            ]);
        } else {
            http_response_code(500);
            echo json_encode([
                'success' => false,
                'message' => 'Ошибка при сохранении данных'
            ]);
        }
        break;
        
    case 'update_task':
        // Проверяем наличие обязательных параметров
        if (!isset($_GET['order_id']) || !isset($_GET['task_id']) || !isset($_GET['status'])) {
            http_response_code(400);
            echo json_encode([
                'success' => false,
                'message' => 'Не указаны обязательные параметры'
            ]);
            exit;
        }
        
        $order_id = (int)$_GET['order_id'];
        $task_id = (int)$_GET['task_id'];
        $status = $_GET['status'];
        
        // Проверяем корректность статуса
        if (!in_array($status, ['planned', 'in-progress', 'completed'])) {
            http_response_code(400);
            echo json_encode([
                'success' => false,
                'message' => 'Некорректный статус задачи'
            ]);
            exit;
        }
        
        $data = read_data($data_file);
        
        // Ищем нужный заказ и задачу
        $found = false;
        foreach ($data as &$order) {
            if ($order['id'] === $order_id) {
                foreach ($order['tasks'] as &$task) {
                    if ($task['id'] === $task_id) {
                        $task['status'] = $status;
                        $found = true;
                        break;
                    }
                }
                
                if ($found) {
                    // Обновляем статус заказа
                    update_order_status($order);
                    break;
                }
            }
        }
        
        if (!$found) {
            http_response_code(404);
            echo json_encode([
                'success' => false,
                'message' => 'Заказ или задача с указанным ID не найдены'
            ]);
            exit;
        }
        
        if (write_data($data_file, $data)) {
            echo json_encode([
                'success' => true,
                'message' => 'Статус задачи успешно обновлен'
            ]);
        } else {
            http_response_code(500);
            echo json_encode([
                'success' => false,
                'message' => 'Ошибка при сохранении данных'
            ]);
        }
        break;
        
    case 'update_order':
        // Проверяем наличие обязательных параметров
        if (!isset($_GET['order_id']) || !isset($_GET['status'])) {
            http_response_code(400);
            echo json_encode([
                'success' => false,
                'message' => 'Не указаны обязательные параметры'
            ]);
            exit;
        }
        
        $order_id = (int)$_GET['order_id'];
        $status = $_GET['status'];
        
        // Проверяем корректность статуса
        if (!in_array($status, ['planned', 'in-progress', 'completed'])) {
            http_response_code(400);
            echo json_encode([
                'success' => false,
                'message' => 'Некорректный статус заказа'
            ]);
            exit;
        }
        
        $data = read_data($data_file);
        
        // Ищем нужный заказ
        $found = false;
        foreach ($data as &$order) {
            if ($order['id'] === $order_id) {
                $order['status'] = $status;
                $found = true;
                break;
            }
        }
        
        if (!$found) {
            http_response_code(404);
            echo json_encode([
                'success' => false,
                'message' => 'Заказ с указанным ID не найден'
            ]);
            exit;
        }
        
        if (write_data($data_file, $data)) {
            echo json_encode([
                'success' => true,
                'message' => 'Статус заказа успешно обновлен'
            ]);
        } else {
            http_response_code(500);
            echo json_encode([
                'success' => false,
                'message' => 'Ошибка при сохранении данных'
            ]);
        }
        break;
        
    case 'update_payment':
        // Проверяем наличие обязательных параметров
        if (!isset($_GET['order_id']) || !isset($_GET['payment'])) {
            http_response_code(400);
            echo json_encode([
                'success' => false,
                'message' => 'Не указаны обязательные параметры'
            ]);
            exit;
        }
        
        $order_id = (int)$_GET['order_id'];
        $payment = $_GET['payment'];
        
        $data = read_data($data_file);
        
        // Ищем нужный заказ
        $found = false;
        foreach ($data as &$order) {
            if ($order['id'] === $order_id) {
                $order['payment'] = $payment;
                $found = true;
                break;
            }
        }
        
        if (!$found) {
            http_response_code(404);
            echo json_encode([
                'success' => false,
                'message' => 'Заказ с указанным ID не найден'
            ]);
            exit;
        }
        
        if (write_data($data_file, $data)) {
            echo json_encode([
                'success' => true,
                'message' => 'Информация об оплате успешно обновлена'
            ]);
        } else {
            http_response_code(500);
            echo json_encode([
                'success' => false,
                'message' => 'Ошибка при сохранении данных'
            ]);
        }
        break;
        
    default:
        http_response_code(400);
        echo json_encode([
            'success' => false,
            'message' => 'Неизвестное действие или отсутствует параметр action'
        ]);
}
